name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      notes:
        description: 'Notes'
        type: string
        required: false
jobs:
  test:
    runs-on: macos-12
    timeout-minutes: 60
    defaults:
      run:
        working-directory: ./test
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 18
    - name: Package the Extension
      run: |
        cd ..
        npx vsce package --out spacegray-input-vscode.vsix
    - name: Install Test Dependencies
      run: npm ci
    - name: Clone VSCode
      run: git clone --depth 10 https://github.com/microsoft/vscode.git vscode
    - name: Get VSCode Version
      id: get-vscode-commit-version
      run: |
        cd vscode
        echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      shell: bash
    - name: Cache Built VSCode
      uses: actions/cache@v3
      env:
        cache-name: vscode-out
      with:
        path: |
          test/vscode/out
          test/vscode/extensions
          test/vscode/.build
        key: ${{ runner.os }}-${{ env.cache-name }}-${{ steps.get-vscode-commit-version.outputs.commit_hash }}
    - name: Cache node_modules
      uses: actions/cache@v3
      env:
        cache-name: node_modules
      with:
        path: |
          **/node_modules
        key: ${{ runner.os }}-${{ env.cache-name }}-vscode-${{ hashFiles('test/vscode/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ env.cache-name }}-
    - name: Build VSCode
      run: |
        cd vscode
        if [ ! -d "./out" ] || [ ! -d "./extensions" ] || [ ! -d "./.build" ] || [ ! -d "./node_modules" ]; then
          yarn && yarn compile
        else
          echo "./out ... directories already exist, skipping the build step."
        fi
    - name: Install Extension
      run: |
        cd vscode
        ./scripts/code-cli.sh --install-extension ../../spacegray-input-vscode.vsix
    - name: Set VSCode Settings
      run: mkdir -p ~/Library/Application\ Support/code-oss-dev/User/settings.json && cp -f ./vscode-settings.json ~/Library/Application\ Support/code-oss-dev/User/settings.json
    - name: Run Tests
      run: npm test
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: screenshots
        path: test/screenshots/
        retention-days: 30
